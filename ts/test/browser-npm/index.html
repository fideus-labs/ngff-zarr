<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NGFF Zarr NPM Package Test</title>
    <script type="importmap">
      {
        "imports": {
          "zod": "./npm/node_modules/zod/index.js",
          "zarrita": "./npm/node_modules/zarrita/dist/src/index.js",
          "@zarrita/storage": "./npm/node_modules/@zarrita/storage/dist/src/index.js",
          "@zarrita/storage/fetch": "./npm/node_modules/@zarrita/storage/dist/src/fetch.js",
          "@zarrita/storage/ref": "./npm/node_modules/@zarrita/storage/dist/src/ref.js",
          "numcodecs": "./npm/node_modules/numcodecs/dist/index.js"
        }
      }
    </script>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .container {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .status {
        padding: 10px;
        margin: 10px 0;
        border-radius: 4px;
      }
      .success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      .info {
        background-color: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }
      pre {
        background: #f8f9fa;
        padding: 10px;
        border-radius: 4px;
        overflow-x: auto;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>NGFF Zarr NPM Package Test</h1>
      <p>
        This page tests the transpiled npm package of NGFF Zarr functionality.
      </p>

      <div id="status" class="status info">
        <strong>Status:</strong> Loading npm package...
      </div>

      <div id="test-results">
        <h2>Test Results</h2>
        <div id="test-output"></div>
      </div>

      <div id="package-info">
        <h2>Package Information</h2>
        <pre id="package-details"></pre>
      </div>
    </div>

    <script type="module">
      // Test loading and using the npm package
      async function runNpmTests() {
        const output = document.getElementById("test-output");
        const status = document.getElementById("status");
        const packageDetails = document.getElementById(
          "package-details",
        );
        const results = [];

        try {
          // Load the npm package
          const ngffZarr = await import("./npm/esm/mod.js");

          // Display package information
          const packageInfo = {
            exports: Object.keys(ngffZarr),
            hasSchemas: "AxisSchema" in ngffZarr,
            hasTypes: "SupportedDims" in ngffZarr,
            hasUtils: "isValidDimension" in ngffZarr,
            version: "0.1.0",
          };

          packageDetails.textContent = JSON.stringify(
            packageInfo,
            null,
            2,
          );

          // Test 1: Package loading
          results.push("✓ NPM package loaded successfully");
          results.push(`✓ Found ${packageInfo.exports.length} exports`);
          results.push(`✓ Has schemas: ${packageInfo.hasSchemas}`);
          results.push(`✓ Has utilities: ${packageInfo.hasUtils}`);

          // Test 2: Metadata validation
          try {
            const { MetadataSchema } = ngffZarr;
            const validMetadata = {
              zarr_format: 2,
              shape: [1000, 1000],
              chunks: [100, 100],
              dtype: "float64",
              compressor: {
                id: "blosc",
                cname: "lz4",
                clevel: 5,
                shuffle: 1,
                blocksize: 0,
              },
              fill_value: 0.0,
              order: "C",
              filters: null,
            };

            const validationResult = MetadataSchema.safeParse(
              validMetadata,
            );
            results.push(
              `✓ Metadata validation: ${
                validationResult.success ? "PASSED" : "FAILED"
              }`,
            );
          } catch (error) {
            results.push(
              `✗ Metadata validation: FAILED - ${error.message}`,
            );
          }

          // Test 3: Units and dimensions validation
          try {
            const { isValidDimension, isValidUnit } = ngffZarr;

            const dimensionTests = {
              x: isValidDimension("x"),
              y: isValidDimension("y"),
              z: isValidDimension("z"),
              t: isValidDimension("t"),
              c: isValidDimension("c"),
              invalid: isValidDimension("invalid"),
            };

            const unitTests = {
              micrometer: isValidUnit("micrometer"),
              millimeter: isValidUnit("millimeter"),
              second: isValidUnit("second"),
              invalid: isValidUnit("invalid"),
            };

            const dimensionsPassed = dimensionTests.x &&
              dimensionTests.y && dimensionTests.z &&
              dimensionTests.t && dimensionTests.c &&
              !dimensionTests.invalid;

            const unitsPassed = unitTests.micrometer &&
              unitTests.millimeter &&
              unitTests.second && !unitTests.invalid;

            results.push(
              `✓ Dimension validation: ${
                dimensionsPassed ? "PASSED" : "FAILED"
              }`,
            );
            results.push(
              `✓ Unit validation: ${unitsPassed ? "PASSED" : "FAILED"}`,
            );
          } catch (error) {
            results.push(
              `✗ Units/dimensions validation: FAILED - ${error.message}`,
            );
          }

          // Test 4: Performance benchmark
          try {
            const { MetadataSchema } = ngffZarr;
            const start = performance.now();

            // Run validation 1000 times
            for (let i = 0; i < 1000; i++) {
              const metadata = {
                zarr_format: 2,
                shape: [100, 100],
                chunks: [10, 10],
                dtype: "float64",
                compressor: null,
                fill_value: 0,
                order: "C",
                filters: null,
              };

              MetadataSchema.safeParse(metadata);
            }

            const end = performance.now();
            const duration = end - start;
            const validationsPerSecond = 1000 / (duration / 1000);

            results.push(
              `✓ Performance test: ${
                Math.round(validationsPerSecond)
              } validations/sec`,
            );
          } catch (error) {
            results.push(
              `✗ Performance test: FAILED - ${error.message}`,
            );
          }

          // Update status
          status.className = "status success";
          status.innerHTML =
            "<strong>Status:</strong> All tests completed successfully";
        } catch (error) {
          results.push(`✗ Package loading: FAILED - ${error.message}`);
          status.className = "status error";
          status.innerHTML = `<strong>Error:</strong> ${error.message}`;
        }

        output.innerHTML = results.join("<br>");
      }

      // Run tests when DOM is ready
      document.addEventListener("DOMContentLoaded", runNpmTests);
    </script>
  </body>
</html>
